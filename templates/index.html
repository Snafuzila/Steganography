<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Steganography UI</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
  </head>
  <body>
    <div class="container">
      <h1>StegX</h1>
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="flash-container">
            {% for category, msg in messages %}
              <div class="flash {{ category }}">{{ msg }}</div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      <div class="grid">
        <section class="card">
          <h2>Encrypt</h2>
          <form action="{{ url_for('encode') }}" method="post" enctype="multipart/form-data">
            <div class="field">
              <label>Choose file type</label>
              <select name="file_type" id="file_type" required>
                <option value="" disabled selected>Select type…</option>
                {% for t in allowed_types %}
                  <option value="{{ t }}">{{ t }}</option>
                {% endfor %}
              </select>
              <p class="hint">Supported: txt, css, html, mov, mkv, avi, png, bmp, wav</p>
            </div>

            <div id="video_params" class="video-params" style="display:none;">
              <div class="field">
                <label>Frame duration (seconds)</label>
                <input type="text" name="frame_duration" placeholder="0.1" />
              </div>
              <div class="field">
                <label>Compare fraction (0-1)</label>
                <input type="text" name="compare_fraction" placeholder="0.5" />
              </div>
              <div class="field">
                <label>Header bits</label>
                <input type="text" name="header_bits" placeholder="1010101010101010" />
              </div>
              <div class="field">
                <label>Footer bits</label>
                <input type="text" name="footer_bits" placeholder="0101010101010101" />
              </div>
            </div>
            <div class="field">
              <label>Password</label>
              <input type="password" name="password" placeholder="Enter password" required />
            </div>
            <div class="field">
              <label>Message to hide</label>
              <textarea name="message" placeholder="Type your secret message" rows="4" required></textarea>
            </div>
            <div class="field">
              <label>Upload file</label>
              <input type="file" name="upload_file" required />
            </div>
            <div id="wav_params" class="video-params" style="display:none;">
              <div class="field">
                <label>WAV LSBs per sample (1-3)</label>
                <input type="text" name="wav_n_lsb" placeholder="1" />
              </div>
            </div>
            <div class="actions">
              <button type="submit">Encrypt</button>
            </div>
          </form>
        </section>

        <section class="card">
          <h2>Decrypt</h2>
          <form action="{{ url_for('decode') }}" method="post" enctype="multipart/form-data">
            <div class="field">
              <label>Choose file type</label>
              <select name="decode_file_type" id="decode_file_type" required>
                <option value="" disabled selected>Select type…</option>
                {% for t in allowed_types %}
                  <option value="{{ t }}">{{ t }}</option>
                {% endfor %}
              </select>
            </div>
            <div id="decode_video_params" class="video-params" style="display:none;">
              <div class="field">
                <label>Frame duration (seconds)</label>
                <input type="text" name="decode_frame_duration" placeholder="0.1" />
              </div>
              <div class="field">
                <label>Compare fraction (0-1)</label>
                <input type="text" name="decode_compare_fraction" placeholder="0.5" />
              </div>
              <div class="field">
                <label>Header bits</label>
                <input type="text" name="decode_header_bits" placeholder="1010101010101010" />
              </div>
              <div class="field">
                <label>Footer bits</label>
                <input type="text" name="decode_footer_bits" placeholder="0101010101010101" />
              </div>
            </div>
            <div class="field">
              <label>Password</label>
              <input type="password" name="decode_password" placeholder="Enter password (for text types)" />
            </div>
            <div class="field">
              <label>Upload file</label>
              <input type="file" name="decode_upload_file" required />
            </div>
            <div id="decode_wav_params" class="video-params" style="display:none;">
              <div class="field">
                <label>WAV LSBs per sample (1-3)</label>
                <input type="text" name="decode_wav_n_lsb" placeholder="1" />
              </div>
            </div>
            <div class="actions">
              <button type="submit">Decrypt</button>
            </div>
          </form>
        </section>
      </div>

      <!-- No listing of example or uploaded files -->
    </div>
  </body>
  <script>
    const typeSelect = document.getElementById('file_type');
    const params = document.getElementById('video_params');
    function toggleParams() {
      const v = (typeSelect?.value || '').toLowerCase();
      const isVideo = v === 'avi' || v === 'mkv' || v === 'mov';
      const isWav = v === 'wav';
      if (isVideo) {
        params.style.display = '';
      } else {
        params.style.display = 'none';
      }
      document.getElementById('wav_params').style.display = isWav ? '' : 'none';
    }
    typeSelect?.addEventListener('change', toggleParams);
    toggleParams();

    const dTypeSelect = document.getElementById('decode_file_type');
    const dParams = document.getElementById('decode_video_params');
    function dToggleParams() {
      const v = (dTypeSelect?.value || '').toLowerCase();
      const isVideo = v === 'avi' || v === 'mkv' || v === 'mov';
      const isWav = v === 'wav';
      if (isVideo) {
        dParams.style.display = '';
      } else {
        dParams.style.display = 'none';
      }
      document.getElementById('decode_wav_params').style.display = isWav ? '' : 'none';
    }
    dTypeSelect?.addEventListener('change', dToggleParams);
    dToggleParams();

    // Auto-start download after redirect if server provided a file
    const urlParams = new URLSearchParams(window.location.search);
    const dl = urlParams.get('download');
    if (dl) {
      const link = document.createElement('a');
      link.href = `${window.location.origin}${window.location.pathname.replace(/\/$/, '')}/download/${encodeURIComponent(dl)}`;
      link.download = dl;
      document.body.appendChild(link);
      link.click();
      link.remove();
    }
  </script>
  </html>


